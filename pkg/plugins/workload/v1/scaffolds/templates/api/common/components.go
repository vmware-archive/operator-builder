package common

import (
	"path/filepath"

	"sigs.k8s.io/kubebuilder/v3/pkg/machinery"
)

var _ machinery.Template = &Components{}

// Components scaffolds the interfaces between workloads.
type Components struct {
	machinery.TemplateMixin
	machinery.BoilerplateMixin

	IsStandalone bool
}

func (f *Components) SetTemplateDefaults() error {
	f.Path = filepath.Join("apis", "common", "components.go")

	f.TemplateBody = commonTemplate

	return nil
}

const commonTemplate = `
// +build !ignore_autogenerated

{{ .Boilerplate }}
package common

import (
	"context"

	"github.com/go-logr/logr"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	{{ if not .IsStandalone -}}
	"k8s.io/apimachinery/pkg/runtime/schema"
	"k8s.io/apimachinery/pkg/types"
	{{ end -}}
	"k8s.io/apimachinery/pkg/runtime"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/controller"
)

type Component interface {
	{{ if not .IsStandalone -}}
	GetComponentGVK() schema.GroupVersionKind
	GetDependencies() []Component
	GetDependencyStatus() bool
	{{ end -}}
	GetReadyStatus() bool
	GetStatusConditions() []Condition

	{{ if not .IsStandalone -}}
	SetReadyStatus(bool)
	SetDependencyStatus(bool)
	{{ end -}}
	SetStatusConditions(Condition)
}

type ComponentReconciler interface {
	// attribute exporters and setters
	GetClient() client.Client
	GetComponent() Component
	GetContext() context.Context
	GetController() controller.Controller
	GetLogger() logr.Logger
	GetScheme() *runtime.Scheme
	GetResources(Component) ([]metav1.Object, error)
	GetWatches() []client.Object
	SetWatch(client.Object)

	// component and child resource methods
	CreateOrUpdate(metav1.Object) error
	UpdateStatus() error

	// methods from the underlying client package
	Create(ctx context.Context, obj client.Object, opts ...client.CreateOption) error
	Patch(ctx context.Context, obj client.Object, patch client.Patch, opts ...client.PatchOption) error
	{{ if not .IsStandalone -}}
	Get(context.Context, types.NamespacedName, client.Object) error
	List(context.Context, client.ObjectList, ...client.ListOption) error
	Update(ctx context.Context, obj client.Object, opts ...client.UpdateOption) error

	// custom methods which are managed by consumers
	CheckReady() (bool, error)
	Mutate(*metav1.Object) ([]metav1.Object, bool, error)
	Wait(*metav1.Object) (bool, error)
	{{ end -}}
}
`
